name: Build Complete LTW-Turbo APK

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
        
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: gradle
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
        
    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Cache NDK
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/ndk
        key: ${{ runner.os }}-ndk-${{ hashFiles('**/ndkVersion') }}
        restore-keys: |
          ${{ runner.os }}-ndk-
          
    - name: Make gradlew executable
      run: |
        chmod +x ./gradlew
        chmod +x ./capacitor-android/gradlew
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build LTW-Turbo Library
      run: |
        ./gradlew :ltw:assembleRelease
        
    - name: Extract SO files from AAR
      run: |
        mkdir -p temp_aar
        cd temp_aar
        unzip -q ../ltw/build/outputs/aar/ltw-release.aar
        cd ..
        
        # Create jniLibs directories
        mkdir -p capacitor-android/app/src/main/jniLibs/{armeabi-v7a,arm64-v8a,x86_64}
        
        # Copy SO files
        for arch in armeabi-v7a arm64-v8a x86_64; do
          if [ -f "temp_aar/jni/$arch/libltw_turbo.so" ]; then
            cp "temp_aar/jni/$arch/libltw_turbo.so" "capacitor-android/app/src/main/jniLibs/$arch/"
            echo "âœ… Copied $arch/libltw_turbo.so"
          else
            echo "âš ï¸ Warning: $arch/libltw_turbo.so not found"
          fi
        done
        
        # List copied files
        find capacitor-android/app/src/main/jniLibs -name "*.so" -ls
        
    - name: Sync Capacitor
      run: |
        npx cap sync android
        
    - name: Build APK
      run: |
        cd capacitor-android
        ./gradlew assembleDebug
        
    - name: Sign APK (Debug)
      run: |
        cd capacitor-android
        # Debug signing is already configured in build.gradle
        echo "APK is already signed with debug keystore"
        
    - name: Verify APK
      run: |
        APK_FILE="capacitor-android/app/build/outputs/apk/debug/app-debug.apk"
        if [ -f "$APK_FILE" ]; then
          echo "âœ… APK built successfully: $APK_FILE"
          echo "ðŸ“ APK size: $(du -h $APK_FILE | cut -f1)"
          
          # Verify SO files are included
          if unzip -l "$APK_FILE" | grep -q "libltw_turbo.so"; then
            echo "âœ… libltw_turbo.so found in APK"
          else
            echo "âŒ libltw_turbo.so NOT found in APK"
            exit 1
          fi
          
          # Verify plugin metadata
          if unzip -l "$APK_FILE" | grep -q "AndroidManifest.xml"; then
            echo "âœ… AndroidManifest.xml found in APK"
          fi
        else
          echo "âŒ APK file not found"
          exit 1
        fi
        
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4.6.0
      with:
        name: ltw-turbo-apk
        path: capacitor-android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: Generate Release Info
      run: |
        APK_FILE="capacitor-android/app/build/outputs/apk/debug/app-debug.apk"
        APK_SIZE=$(du -h $APK_FILE | cut -f1)
        APK_HASH=$(sha256sum $APK_FILE | cut -d' ' -f1)
        
        cat > release-info.md << EOF
        # LTW-Turbo APK æž„å»ºå®Œæˆ
        
        ## APK ä¿¡æ¯
        - **æ–‡ä»¶å**: app-debug.apk
        - **å¤§å°**: $APK_SIZE
        - **SHA256**: $APK_HASH
        - **åŒ…å**: com.ltw.plugin.renderer.ltw.turbo
        - **ç‰ˆæœ¬**: 1.0
        
        ## åŠŸèƒ½ç‰¹æ€§
        - âœ… HTML ç•Œé¢æ˜¾ç¤º
        - âœ… æ¸²æŸ“å™¨æ’ä»¶æ ‡è¯†
        - âœ… æ”¯æŒ armeabi-v7a, arm64-v8a, x86_64
        - âœ… å…¼å®¹ Pojav/Boat/FCL å¯åŠ¨å™¨
        - âœ… ä½¿ç”¨ libltw_turbo.so æ¸²æŸ“åº“
        
        ## å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½ APK æ–‡ä»¶
        2. åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…
        3. å¯åŠ¨å™¨ä¸­ä¼šæ˜¾ç¤º "LTW (OpenGL 3.2 and 4.6, All Version)"
        
        ## æž„å»ºä¿¡æ¯
        - **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **æäº¤**: ${{ github.sha }}
        - **åˆ†æ”¯**: ${{ github.ref_name }}
        EOF
        
    - name: Upload Release Info
      uses: actions/upload-artifact@v4.6.0
      with:
        name: release-info
        path: release-info.md
        retention-days: 30
        
    - name: Create Release (Tag only)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          capacitor-android/app/build/outputs/apk/debug/app-debug.apk
          release-info.md
        name: LTW-Turbo ${{ github.ref_name }}
        body_path: release-info.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}